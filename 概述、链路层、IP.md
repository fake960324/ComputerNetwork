# 概述
* 分层
1. `链路层`
  处理与电缆（或其他任何传输媒介）的物理接口细节。
2. `网络层`
  处理分组在网络中的活动，例如分组选路。`IP`/`ICMP`/`IGMP`
3. `运输层`
  为两台主机上的应用程序提供端到端的通讯。`TCP`/`UDP`
4. `应用层`
  处理特定的应用程序细节
  
* 通过路由器连接的两个网络
  * 端到端系统（end system）
  * 中间系统（intemediate system）
  * 应用层和传输层使用端到端（end to end）协议
  * 网络层提供逐跳（hop to hop）协议
  * 网络ip提供的是一种`不可靠的服务`，他只是尽可能地把分组从源节点送到目的节点，但不提供可靠性保证。
  * TCP在不可靠的IP层上提供一个`可靠的运输层`
  * 互联网的目的之一就是在应用程序中隐藏所有的物理细节
* TCP/IP协议族中不同层次的协议
  * TCP使用不可靠的IP服务，并提供一种*可靠的运输层服务* 。
  * UDP为应用程序发送和接收数据报，和TCP不同，UDP是*不可靠* 的。
  * IP是网络层上的主要协议，同时被TCP和UDP使用。
  * ICMP是IP协议的附属协议

* 封装
  * 以太网数据帧的`物理特性`是其*长度必须在46~1500字节* 之间。
  * 以太网的帧收不也有一个*16bit* 的`帧类型域`（ip,arp,rarp）
  * IP在首部存入一个长度为*8bit* 的数值，称作`协议域`（icmp，igmp，tcp，udp，esp，gre）
  * TCP和UDP都使用一个*16bit*的`端口号`来表示不同的应用程序（ftp，telnet，http）<br>
![帧封装](https://github.com/fake960324/ComputerNetwork/blob/master/Pics/%E5%B8%A7%E5%B0%81%E8%A3%85.jpg)<br>
* 分用<br>
![帧分用](https://github.com/fake960324/ComputerNetwork/blob/master/Pics/%E9%80%9A%E8%AE%AF%E5%B8%A7%E5%88%86%E7%94%A8.jpg)<br>
* 端口号（用于识别应用程序）
  * 服务器一般都是通过`知名端口号`来识别的（tfp 21，telnet 23）。
  * 客户端口号又称作`临时端口号`（即存在时间很短暂）
  * 大多数TCP/IP实现给`临时端口`分配*1024~5000* 之间的端口号。
  * 大于5000的端口号是为其他服务器预留的（Internet上并不常用的服务）
  
# 链路层
* 以太网
  1. 以太网是指数字设备公司，英特尔公司在1982年联合公布的一个标准
  2. 它采用一种称作CSMA/CD的媒体介入方法
  3. 他的速率*10Mb/s* ，地址*48bit*
  
* IEEE 802封装
  1. 802.3针对整个CSMA/CD
  2. 802.4针对令牌总线网络
  3. 802.4针对令牌环网络
  4. 这三者的共同特性由802.2标准来定义，802网络*共有的逻辑链路控制*
* 封装格式<br>
![以太网帧格式](https://github.com/fake960324/ComputerNetwork/blob/master/Pics/%E4%BB%A5%E5%A4%AA%E7%BD%91.jpg)<br>
下方为以太网帧格式<br>
  * 两种种帧格式都采用*48bit* （6字节）的目的地址和源地址
  * ARP和RARP协议对*32bit的IP地址* 和*48bit的硬件地址* 进行映射
  * 802定义*有效长度值* 与以太网有效类型值无一相同，这样就可以对两种帧格式进行区分。
  * 目的服务访问节点（DSAP）和源服务访问点(SSAP)的值都设为0xaa，ctrl字段的值设为0x03，随后的3个字节org code都置位0.在记下来的两个字节类型字段和以太网帧格式一样。
  * 802.3规定数据部分必须至少38字节，对于以太网，则要求最少46字节。为保证这一点，必须在不足的控件插入填充（pad）字节
* 环回接口
  * 传给*环回地址（一般是127.0.0.1）* 的任何数据均作为IP输入（127开头的IP）
  * 传给`广播地址`或`多播地址`的数据报*复制一份传给环回接口*，然后送到以太网上。这是因为广播传送和多播传送的定义包含主机本身。
  * 任何传给该主机IP地址的数据均送到环回接口。<br>
![环回接口](https://github.com/fake960324/ComputerNetwork/blob/master/Pics/%E7%8E%AF%E5%9B%9E%E6%8E%A5%E5%8F%A3.jpg)<br>
  * ping 环回口地址：通过环回口返回主机
  * ping 广播地址：拷贝一份通过环回口返回主机，另一份发到以太网
  * ping 自己地址：通过环回口返回主机
  * ping 其他地址：通过ARP获取mac进行通讯
>IP地址：`逻辑地址`<br>
mac地址：`硬件地址`<br>
ARP：通过IP逻辑地址得到mac硬件地址
* MTU和路径MTU
  * 以太网和802.3对`数据帧长度`都有一个限制，其最大值分别是1500和1492字节。链路层的这一特性称作MTU，最大传输单元
  * 如果IP层有一个数据报要传，而且数据的长度比链路层的MTU还大，那么IP层就需要进行`分片`，将数据分成若干偏，这样每一片都小于MTU
  * `点到点的链路层`（如SLIP何PPP）的MTU并非指的是网络媒体的物理特性。相反，它是一个`逻辑限制`，目的是为交互使用提供足够快的响应时间。
  * 两台通信主机路径中`最小MTU`。他被称为`路径MTU`
  * 路径MTU在两个方向上不一定是一致的
  * MTU在出方向计算
  
# IP
* `IP`是`TCP/IP协议族`中最为核心的协议。所有的`TCP`、`UDP`、`ICMP`及`IGMP`数据都以`IP`数据报格式传输。
* `IP`提供**不可靠**、**无连接**的数据报传送服务。
* **不可靠**：他不能保证IP数据报都更够成功地到达目的地。IP仅提供**最好的传输服务**。如果发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法：**丢弃该数据包**，然后`ICMP`消息报给信源端。任何要求的`可靠性`必须由上层来提供（如`TCP`）
* **无连接**：`IP`**不维护任何关于后续数据报的状态信息**。每个数据报的处理是相互独立的。IP数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报（先A后B），每个数据报都是**独立地进行路由选择**，可能选择不同的路线，因此B可能在A之前先到达
* 两个有用指令：ipconfig和netstat
* IP首部<br>
![IP首部](https://github.com/fake960324/ComputerNetwork/blob/master/Pics/IP%E9%A6%96%E9%83%A8.jpg)<br>
  * 首部长度4位：0~15，每位表示4个字节，32bit。所以IP首部最多60个字节。
  * **服务类型TOS位**8位：前3位为IP优先级，后4位TOS子字段和最右侧一位未用置0<br>
![服务类型TOS子字段](https://github.com/fake960324/ComputerNetwork/blob/master/Pics/TOS%E5%AD%97%E6%AE%B5.jpg)<br>
  * 总长度（字节数）16位：IP头部长+数据长度。最长不能超过65535个字节
  * **标识16位**：`数据包`标号，跟操作系统有关。每个包有一个ID，多发一个ID+1。**数据包可能被分片**，但无论怎么分该包标号都不变
  * 3位标志位：有两位在用，一位未用
    * df：遇到MTU比当前数据长度小时，直接丢弃
    * mf：更多分片
  * 13位片偏移：数据包分片距离0位置的偏移量。之前的分片长度
  * 8位**生存时间TTL**：初始255，每过一个路由器就-1。为了防止网络中有环装结构，TTL减为0时丢弃。
  * 8位协议位：标志数据使用的是什么协议。1：ICMP；6：TCP；17：UDP
  * 选项：最多40字节。以32位为单位，保证首部始终是32位倍数
    * 安全和处理机制
    * 路径记录
    * 时间戳
    * 宽松的源站选路
    * 严格的源站选路
* IP路由选择<br>
![IP路由选择](https://github.com/fake960324/ComputerNetwork/blob/master/Pics/IP%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9.jpg)<br>
  * 跨网关时：数据报中**IP地址不变**，链路层的**mac地址随逐跳变化**。
  
  
  
  
  
  
